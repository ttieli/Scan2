# 会话记录

- **时间**: 2026-02-03 12:05:30
- **会话ID**: qr2d

## ✅ 完成
- 修复 QRCode.js RS_BLOCK_TABLE v15 H 级别截断 bug：`[11,36,12]` → `[11,36,12,7,37,13]`（sender.html + test.html）
- 修复 UTF-8 BOM 问题：QRCode.js 对含非 ASCII 的 JSON 添加 BOM，导致 JSON.parse 失败（receiver.html + test.html）
- 创建 test.html 自动化 E2E 测试：编码→QR生成→QR解码→重组→校验，9个测试用例全部通过
- 从 GitHub 仓库移除 .gitignore 文件
- **根因分析**（systematic debugging）：文件模式 QR 码太密集无法扫描
  - 根因：`getChunkSizes` 值只考虑 base64 数据，未计入 ~48 字节 JSON 包装开销
  - 结果：所有文件模式 QR 码都是 v15-v17（77-85×85 模块），手机无法可靠扫描
  - 对比：文本模式用小分片（v7, 45×45）→ 容易扫描；文件模式用大分片 → 太密
- **实施修复**：
  - `getChunkSizes` 降低 rest 值，目标 QR v10（57×57 模块）：H:70, Q:100, M:160, L:220
  - `chunkFile` 重构：Fragment 0 只含元数据（无 base64 数据），v11-v12（61-65 模块）
  - Fragment 1+ 只含数据，目标 v10
  - 同步更新 test.html 和 estimateQRCount()

## 📋 计划
- 用户测试新的分片大小是否能可靠扫描
- 测试通过后 commit 并 push
- 更新构建时间戳

## ⏸️ 未完成
- 未在浏览器中验证新分片大小的测试结果（等用户反馈）
- 未 commit（等测试通过）

## ⚠️ 问题
- 浏览器自动化工具无法处理 file:// URL（navigate 工具强制添加 https://）
- 用户拒绝 localhost 方案，需手动在浏览器中测试

## 💡 备注
- QR 版本与模块数：v=版本号，模块数 = v×4+17。v10=57×57（可靠），v12=65×65（尚可），v15+=77×77+（太密）
- 文件模式 QR 容量分析（H级）：v10=119字节，v12=155字节，JSON包装≈48字节
- Fragment 0 元数据（ASCII文件名）≈130字节 → v11 H；中文文件名+BOM ≈143字节 → v12 H
- 此修改向后兼容：旧版 receiver 可正常处理 data="" 的 fragment 0
- 历史: Phase 1→Phase 2→Apple重设计→QR UTF-8 fix→F1/F2/F3→QR cache fix→missing fragments fix→第一片QR容量fix→**RS表修复+BOM修复+QR密度修复**
