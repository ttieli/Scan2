# QR数据传输系统 - 完全离线版

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![GitHub Pages](https://img.shields.io/badge/GitHub-Pages-brightgreen)](https://ttieli.github.io/Scan/)
[![Version](https://img.shields.io/badge/Version-2.3.0-blue)](https://github.com/ttieli/Scan)

通过QR码实现完全离线的数据传输，仅需3个HTML文件。

## 🚀 在线体验

- **GitHub Pages**: https://ttieli.github.io/Scan/
- **发送端**: https://ttieli.github.io/Scan/sender.html
- **接收端**: https://ttieli.github.io/Scan/receiver.html

## 📦 极简结构

```
仅3个文件：
├── index.html      # 主页（6.7KB）
├── sender.html     # 发送端（23.5KB）
└── receiver.html   # 接收端（254KB）
```

## ✨ 核心特性

- 🔒 **完全离线** - 所有代码内嵌，无需网络
- 📱 **零依赖** - 无需安装任何软件
- 🚀 **即开即用** - 下载即可使用
- 🌐 **跨平台** - 支持所有现代浏览器
- 📊 **智能分片** - 自动处理长文本
- 🎯 **iOS优化** - 完美支持Safari浏览器
- 📷 **摄像头控制** - 可调整显示大小/隐藏画面
- 🔊 **音效反馈** - 扫描成功提示音
- 🔗 **通用二维码** - 兼容微信/支付宝/Apple相机扫描（v2.3新增）
- 📁 **文件传输** - 支持任意文件类型的离线传输（v2.3新增）
- 💾 **会话恢复** - 断线重连自动恢复传输进度（v2.3新增）

## 💡 使用方法

### 方式一：直接使用（仅发送）
1. 下载3个HTML文件
2. 双击打开 `sender.html`
3. 输入文本，生成QR码

### 方式二：完整功能（推荐）
```bash
# 启动本地服务器
python3 -m http.server 8000
# 访问 http://localhost:8000
```

### 方式三：GitHub Pages
直接访问 https://ttieli.github.io/Scan/

## 📱 功能说明

### 发送端 (sender.html)

#### 通用模式（新功能）
- 🔗 **第三方扫描器兼容**：生成标准QR码，支持微信、支付宝、Apple相机直接扫描
- ⚙️ **纠错级别可选**：L/M/Q/H四种级别，平衡容量与容错
- 📏 **容量提示**：实时显示当前纠错级别的最大数据容量
- ⚠️ **智能编码**：自动检测中文和特殊字符，提供percent编码并给出警告

#### 私有模式（增强）
- 📝 **文本传输**：支持中文和特殊字符，自动Base64编码
- 🎯 **智能分片**：根据文本长度自动优化分片策略
- 📊 **显示模式**：平铺或循环播放，循环模式QR码放大显示
- 🎬 **速度可调**：循环播放速度1-5秒可调
- 📁 **文件传输（新功能）**：
  - 支持任意文件类型（图片、文档、视频等）
  - 拖放或点击上传
  - 智能预估QR码数量和扫描时间
  - 自动分片和校验和计算
  - 安全警告（可执行文件提示）

### 接收端 (receiver.html)

#### 扫描功能
- 📷 **摄像头扫描**：启动摄像头扫描QR码
- 🔍 **实时进度**：显示扫描进度（已接收X/Y片）
- 📊 **可视化状态**：彩色显示片段接收状态
- 🎮 **画面控制**：隐藏/最小化/正常三种模式
- 📱 **iOS优化**：完美支持Safari浏览器
- 🔊 **音效反馈**：扫描成功提示音

#### 会话恢复（新功能）
- 💾 **自动保存**：接收过程中自动保存进度到LocalStorage
- 🔄 **断线恢复**：页面关闭或刷新后自动恢复会话
- ⏰ **24小时TTL**：会话有效期24小时
- 🎯 **智能识别**：自动识别文本或文件传输类型

#### 文件接收（新功能）
- 📁 **自动识别**：智能识别文件传输协议
- 📊 **进度显示**：实时显示已接收片数和数据大小
- 🔒 **完整性校验**：SHA校验和验证确保文件完整
- 💾 **自动下载**：接收完成后提供下载按钮
- 🍎 **iOS兼容**：使用Blob API确保iOS Safari下载兼容性

### 主页 (index.html)
- 🏠 快速导航到发送/接收端
- 📖 功能介绍和使用说明

## 🎯 最新更新 (v2.3.0)

### 2025-10-13 - v2.3.0 重大更新

#### 🔗 通用二维码模式（User Story 1）
- ✅ **第三方扫描器兼容**：生成标准QR码，支持微信、支付宝、Apple相机等第三方扫描器
- ✅ **模式选择**：增加"通用模式"和"私有模式"切换，满足不同使用场景
- ✅ **纠错级别可选**：提供L/M/Q/H四种纠错级别，平衡数据容量与容错能力
- ✅ **智能编码**：自动检测中文和特殊字符，应用percent编码并给出友好警告
- ✅ **容量提示**：实时显示当前纠错级别的最大数据容量

#### 💾 会话恢复功能（User Story 2）
- ✅ **自动保存**：传输过程中自动保存进度到LocalStorage
- ✅ **断线恢复**：页面关闭或刷新后自动恢复未完成的传输会话
- ✅ **恢复横幅**：检测到未完成会话时显示黄色提示横幅
- ✅ **24小时TTL**：会话有效期24小时，过期自动清除
- ✅ **智能识别**：自动识别文本或文件传输类型并恢复对应状态

#### 📁 文件传输功能（User Story 3）
- ✅ **文件上传**：支持拖放或点击上传任意类型文件
- ✅ **智能预估**：实时显示预计生成的QR码数量和扫描时间
- ✅ **自动分片**：将文件编码为Base64并自动分片（每片2800字节）
- ✅ **完整性校验**：使用SHA校验和确保文件传输完整性
- ✅ **自动识别**：接收端自动识别文件传输协议
- ✅ **进度显示**：实时显示已接收片数和数据大小
- ✅ **文件下载**：接收完成后提供下载按钮，iOS Safari完美兼容
- ✅ **安全警告**：检测可执行文件类型并给出安全提示
- ✅ **会话恢复**：支持文件传输的断线恢复功能

---

### 2025-09-03 - v2.2.0
- ✅ **高级QR选项**：可选择纠错级别（L/M/Q/H）控制数据容量
- ✅ **分片策略控制**：提供小/中/大/超大分片选项
- ✅ **循环播放增强**：循环模式下QR码放大1.5倍显示
- ✅ **播放速度调节**：支持1-5秒可调播放速度

### 2025-09-02 - v2.1.0
- ✅ **智能分片优化**：长文本自动调整分片大小，减少QR码数量
- ✅ **iOS Safari支持**：修复扫描界面显示问题，优化移动端体验
- ✅ **摄像头控制**：新增隐藏/最小化功能，节省屏幕空间
- ✅ **进度可视化**：彩色显示片段接收状态（绿色已接收，红色待接收）
- ✅ **音效反馈**：扫描成功时播放提示音
- ✅ **中文编码修复**：Base64编码解决微信等扫描器乱码问题

## ⚠️ 注意事项

### 通用模式
- **第三方扫描器限制**：微信、支付宝、Apple相机仅支持单个QR码扫描，不支持分片
- **数据容量**：根据纠错级别，单个QR码最大容量约1.2-3KB
- **中文支持**：中文和特殊字符会被percent编码，扫描结果可能显示为编码格式（如%E4%B8%AD）
- **推荐使用场景**：短链接、简单文本、联系方式、WiFi密码等

### 私有模式（文本传输）
- 摄像头功能需要HTTPS或localhost环境（浏览器安全限制）
- iOS用户建议使用Safari浏览器以获得最佳体验
- 长文本会自动分片，建议控制在1000字符以内

### 私有模式（文件传输）
- **推荐文件大小**：< 100KB（约35个QR码，扫描约70秒）
- **可接受范围**：100KB - 500KB（35-175个QR码，扫描约2-6分钟）
- **极限测试**：支持1MB+文件，但需要350+个QR码，扫描时间较长
- **支持文件类型**：
  - ✅ 图片：jpg, png, gif, webp等
  - ✅ 文档：pdf, txt, doc, xlsx等
  - ✅ 压缩包：zip, rar, 7z等
  - ✅ 其他：任意二进制文件
  - ⚠️ 可执行文件：会显示安全警告，请确认文件来源
- **iOS Safari**：使用Blob API确保下载兼容性，文件会自动保存到"下载"文件夹
- **会话恢复**：传输过程中可安全关闭页面，24小时内可恢复进度

## 🔧 技术细节

### 通用模式
- **QR码格式**：标准QR Code格式，纯文本内容（无JSON包装）
- **编码方式**：
  - 纯英文：直接编码，完美兼容第三方扫描器
  - 中文/特殊字符：percent编码（encodeURIComponent）
- **QR纠错级别**：
  - L级：7%纠错，容量~2953字节
  - M级：15%纠错，容量~2331字节
  - Q级：25%纠错，容量~1663字节
  - H级：30%纠错，容量~1273字节
- **限制**：单个QR码，不支持分片

### 私有模式（文本传输）
- **QR码格式**：JSON格式 `{i: index, t: total, d: data, e: encoding}`
- **编码方式**：Base64编码支持中文和特殊字符
- **分片策略**：
  - 自动模式：根据文本长度智能调整
  - 小分片：15字符/片（适合简单扫描器）
  - 中分片：30字符/片（平衡模式）
  - 大分片：50字符/片（减少QR数量）
  - 超大分片：80字符/片（最少QR数量）

### 私有模式（文件传输）
- **QR码格式**：JSON格式 `{type: "file", index, total, data, metadata}`
- **编码方式**：FileReader.readAsDataURL → Base64编码
- **分片大小**：2800字节/片（保守估计JSON开销）
- **元数据**：仅在第一片包含 `{fileName, mimeType, fileSize, checksum}`
- **校验和**：简单hash算法验证文件完整性
- **文件大小预估**：`base64Size = fileSize * 1.37`，`qrCount = ceil(base64Size / 2800)`

### 会话恢复
- **存储位置**：浏览器LocalStorage
- **存储内容**：`{id, type, createdAt, totalFragments, receivedFragments, metadata}`
- **TTL**：24小时（86400000ms）
- **UUID格式**：标准UUID v4格式
- **自动检测**：页面加载时自动调用 `checkSessionRecovery()`

## 📄 许可证

MIT License - 自由使用

---

极简、安全、可靠的离线数据传输方案 | [报告问题](https://github.com/ttieli/Scan/issues)