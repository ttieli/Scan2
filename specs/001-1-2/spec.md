# Feature Specification: QR传输工具增强 - 通用二维码与文件传输

**Feature Branch**: `001-1-2`
**Created**: 2025-10-13
**Status**: Draft
**Input**: User description: "做一个支持文本的二维码传输接收工具,增加功能1,通用二维码展示,即二维码内容可以用标准二维码工具解析,如微信,苹果摄像头等,此功能不需要支持循环,即发送端可以选择是通用生成和私有规范生成,私有规范支持拆分和循环播放等;增加功能2,支持文件传输,并转换为原始文件,这个用私有规范生成"

## Clarifications

### Session 2025-10-13

- Q: What should be the maximum file size allowed for QR code file transfer? → A: No hard limit. Show estimated QR code count during generation and let users decide whether to proceed.
- Q: How should the system handle special characters that may have compatibility issues in universal mode QR codes? → A: Auto-encode with warning. Automatically encode special characters to UTF-8/percent-encoding, show a non-blocking warning, and allow generation to proceed.
- Q: How should the receiver page handle recovery of interrupted transfer sessions saved in LocalStorage? → A: Auto-recover with clear UI. Automatically resume saved session on page load, show prominent banner with progress and "重新开始" button to clear.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 通用二维码生成(Universal QR Code Generation) (Priority: P1)

Alice需要将一段文本快速分享给同事Bob,但Bob只有微信或手机自带相机,没有安装专用的QR扫描工具。Alice打开发送端页面,输入文本后选择"通用模式",生成一个标准二维码。Bob使用微信"扫一扫"功能即可直接读取文本内容,无需安装任何应用。

**Why this priority**: 这是最基础且使用频率最高的功能,满足日常快速分享文本的需求,且兼容性最广(微信、苹果相机等常见工具都支持)。此功能独立可用,不依赖接收端页面。

**Independent Test**: 用户在sender.html选择"通用模式"输入文本,生成二维码后用微信扫一扫验证能否直接显示原文本内容。

**Acceptance Scenarios**:

1. **Given** 用户在发送端输入50字符以内的文本, **When** 选择"通用模式"并点击生成, **Then** 显示一个标准格式二维码,用微信/苹果相机扫描后直接显示原始文本
2. **Given** 用户在发送端输入包含中文、emoji、特殊字符的文本, **When** 选择"通用模式"生成二维码, **Then** 系统自动将特殊字符编码为UTF-8/percent-encoding格式,显示非阻塞性警告提示"部分特殊字符已编码,可能在某些扫描器显示略有差异",并成功生成二维码
3. **Given** 用户在发送端选择"通用模式", **When** 生成二维码后, **Then** 不显示循环播放控件,只显示单个静态二维码
4. **Given** 用户输入的文本超过通用二维码容量上限, **When** 选择"通用模式", **Then** 系统提示"文本过长,建议使用私有模式"并阻止生成

---

### User Story 2 - 私有协议文本传输(Private Protocol Text Transfer) (Priority: P2)

Carol需要传输一份包含1000字符的长文本给David。Carol在发送端选择"私有模式",系统自动将文本分片并生成多个二维码,支持循环播放。David使用接收端页面扫描,系统自动收集所有分片并还原完整文本。

**Why this priority**: 增强现有私有协议功能,支持长文本传输场景。此功能已有基础(现有系统支持分片和循环),需改进用户体验使其与通用模式区分清晰。

**Independent Test**: 用户在sender.html选择"私有模式"输入500字符文本,生成循环播放的多个二维码,用receiver.html扫描所有二维码后验证是否完整还原原文本。

**Acceptance Scenarios**:

1. **Given** 用户输入200字符以上的文本, **When** 选择"私有模式"并生成, **Then** 系统自动分片并生成多个带有序号(1/N, 2/N...)的二维码,支持循环播放
2. **Given** 用户选择"私有模式"生成多个二维码, **When** 在循环播放模式下, **Then** 用户可以调整播放速度(1-5秒/帧)并看到当前播放进度
3. **Given** 接收端扫描私有模式生成的二维码, **When** 收集到部分分片(如3/5), **Then** 显示实时进度"已接收3/5片"并标记缺失片段
4. **Given** 接收端已收集完所有分片, **When** 系统完成拼接, **Then** 显示完整原始文本并播放成功提示音
5. **Given** 接收端在传输过程中关闭页面后重新打开, **When** 页面加载完成且检测到LocalStorage中有未完成的传输会话, **Then** 自动恢复传输会话并显示明显的横幅提示"已恢复传输会话: 已接收X/Y片",同时提供"重新开始"按钮让用户清除并开始新传输

---

### User Story 3 - 文件传输与还原(File Transfer and Restoration) (Priority: P3)

Emily需要将一个PDF文件(500KB)从电脑A传输到电脑B,但两台电脑之间无法直接连接网络。Emily在发送端上传PDF文件,系统使用私有协议将文件编码为多个二维码并循环播放。Emily用电脑B的接收端扫描所有二维码,系统自动还原并下载原始PDF文件,文件名和扩展名保持不变。

**Why this priority**: 文件传输是高级功能,适用于特定场景(离线环境、安全传输)。相比文本传输,文件传输涉及更大数据量和格式还原,复杂度更高,因此优先级较低。

**Independent Test**: 用户在sender.html上传一个10KB的图片文件(test.jpg),生成私有协议二维码,用receiver.html扫描完成后下载文件,验证文件内容和扩展名是否与原文件一致。

**Acceptance Scenarios**:

1. **Given** 用户在发送端点击"上传文件"按钮, **When** 选择一个文件(如image.png, document.pdf), **Then** 系统显示文件名、大小和类型,并提示预计生成的二维码数量
2. **Given** 用户上传文件后查看预估信息, **When** 文件较大导致预计生成的二维码数量较多(如>100个), **Then** 系统显示友好提示"预计生成X个二维码,扫描需约Y分钟,建议压缩文件以减少二维码数量",但仍允许用户继续生成
3. **Given** 用户上传文件并选择"私有模式", **When** 生成二维码, **Then** 系统将文件转换为Base64编码,添加文件元数据(文件名、扩展名、MIME类型),并分片生成多个二维码
4. **Given** 接收端扫描完所有文件分片, **When** 系统完成还原, **Then** 自动触发浏览器下载,文件名和扩展名与原文件一致,文件内容可正常打开使用
5. **Given** 接收端在文件传输中途停止扫描, **When** 用户重新扫描, **Then** 系统继续从未完成的片段开始接收,已接收片段不需要重复扫描
6. **Given** 接收端在文件传输过程中关闭页面后重新打开, **When** 检测到LocalStorage中有未完成的文件传输会话, **Then** 自动恢复会话并显示横幅"已恢复文件传输: [文件名] 已接收X/Y片",提供"重新开始"按钮清除会话

---

### Edge Cases

- **文本长度边界**: 通用模式下,不同纠错级别(L/M/Q/H)的二维码最大容量不同。当文本长度接近上限时,系统应提前警告用户切换到私有模式。
- **特殊字符处理**: 通用模式二维码在某些扫描器(如微信)中可能对特殊字符有编码限制。系统自动将特殊字符编码为UTF-8/percent-encoding格式,同时显示非阻塞性警告提示用户"部分特殊字符已编码,可能在某些扫描器显示略有差异",允许生成继续进行。
- **文件类型限制**: 文件传输功能应支持常见文件类型(txt, pdf, jpg, png, zip等),但对可执行文件(.exe, .sh, .bat)应给予安全警告。
- **循环播放中断**: 在循环播放模式下,如果用户切换浏览器标签页或最小化窗口,播放可能暂停。系统应在页面重新激活时恢复播放。
- **跨设备兼容性**: iOS Safari对相机API和文件下载有特殊限制,接收端需要特别处理iOS环境下的文件保存流程。
- **大文件处理**: 当文件过大导致生成大量二维码(如>200个)或单个二维码数据密度过高(如Version 40),某些扫描器可能无法识别或用户扫描体验变差。系统应在生成前显示预估信息(二维码数量、预计扫描时间),建议但不强制要求用户压缩文件。
- **传输会话恢复**: 虽然系统完全离线,但用户可能在传输过程中关闭浏览器。接收端使用LocalStorage临时保存已接收片段(有效期24小时),当用户重新打开页面时自动恢复传输会话,显示明显的横幅提示当前进度,并提供"重新开始"按钮让用户清除会话开始新传输。

## Requirements *(mandatory)*

### Functional Requirements

#### 通用二维码模式 (Feature 1)

- **FR-001**: 发送端MUST提供"通用模式"和"私有模式"的明确选择控件(如单选按钮或下拉菜单)
- **FR-002**: 通用模式下生成的二维码MUST使用标准QR Code格式,不包含自定义协议头或元数据
- **FR-003**: 通用模式生成的二维码MUST能被微信"扫一扫"、苹果相机、支付宝等第三方工具直接扫描并显示原始文本
- **FR-004**: 通用模式MUST支持UTF-8编码,正确处理中文、emoji和特殊字符
- **FR-004a**: 通用模式下,当检测到可能存在兼容性问题的特殊字符时,系统MUST自动将其编码为UTF-8/percent-encoding格式,并显示非阻塞性警告提示(如"部分特殊字符已编码,可能在某些扫描器显示略有差异"),允许生成继续
- **FR-005**: 通用模式下,当文本超过单个二维码容量上限时,系统MUST显示明确的错误提示,建议用户切换到私有模式或减少文本长度
- **FR-006**: 通用模式生成的二维码MUST为静态显示,不支持循环播放功能
- **FR-007**: 通用模式MUST允许用户选择纠错级别(L/M/Q/H),并实时显示该纠错级别下可容纳的最大字符数

#### 私有协议增强 (Feature 2 - Text)

- **FR-008**: 私有模式MUST支持文本自动分片,当文本超过单个二维码容量时,自动拆分为多个片段
- **FR-009**: 私有模式生成的二维码MUST包含片段元数据(当前片段序号/总片段数,如"2/5")
- **FR-010**: 私有模式MUST支持循环播放,用户可选择播放速度(1-5秒/帧)
- **FR-011**: 私有模式MUST在界面上显示当前播放的片段序号(如"正在播放: 3/10")
- **FR-012**: 接收端扫描私有模式二维码时,MUST实时显示已接收片段进度(如"已接收5/10片")
- **FR-013**: 接收端MUST支持乱序接收片段,并在收集完所有片段后自动按序拼接还原原始文本
- **FR-014**: 接收端在接收完成后MUST播放成功提示音,并显示完整文本内容

#### 文件传输 (Feature 2 - File)

- **FR-015**: 发送端MUST提供文件上传控件(支持点击选择或拖拽上传)
- **FR-016**: 发送端上传文件后MUST显示文件信息:文件名、文件大小、文件类型(MIME type)
- **FR-017**: 文件传输MUST使用私有协议,不支持通用模式(因为需要携带文件元数据)
- **FR-018**: 系统MUST将文件转换为Base64编码,并添加文件元数据头(包含文件名、扩展名、MIME类型)
- **FR-019**: 文件传输MUST支持分片,根据文件大小自动计算所需的二维码数量,并在生成前显示预估信息(如"预计生成23个二维码,扫描需约2分钟"),不设硬性文件大小上限,让用户根据预估信息自主决定是否继续
- **FR-020**: 文件传输生成的二维码MUST支持循环播放,默认播放速度为2秒/帧
- **FR-021**: 接收端扫描文件分片时,MUST显示文件传输进度(已接收片段/总片段,已接收字节数/总字节数)
- **FR-022**: 接收端完成文件接收后,MUST自动触发浏览器下载,文件名和扩展名与原文件保持一致
- **FR-023**: 接收端MUST在下载前验证文件完整性(如通过校验和),若有分片丢失或损坏,提示用户重新扫描
- **FR-024**: 文件传输MUST支持常见文件类型(txt, pdf, jpg, png, gif, zip, docx等),对可执行文件类型(.exe, .sh, .bat)显示安全警告但仍允许传输
- **FR-025**: 接收端MUST支持中途暂停和恢复,已接收的片段临时保存到LocalStorage(有效期24小时),页面重新加载时自动恢复传输会话,显示明显的横幅提示(如"已恢复传输会话: 已接收X/Y片"或"已恢复文件传输: [文件名] 已接收X/Y片"),并提供"重新开始"按钮让用户清除会话

### Key Entities

- **QR Code Mode**: 表示二维码生成模式,包含两种类型 - "通用模式(Universal)"生成标准QR码,"私有模式(Private)"生成支持分片和元数据的自定义格式QR码
- **Text Message**: 表示待传输的文本内容,包含原始文本字符串、编码格式(UTF-8)、字符长度,在私有模式下可能关联多个QR片段
- **QR Fragment**: 表示私有协议下的二维码片段,包含片段序号、总片段数、实际数据内容、校验信息,用于分片传输和还原
- **File Metadata**: 表示文件的元信息,包含原始文件名、文件扩展名、MIME类型、文件大小(字节),在文件传输时编码到首个二维码片段中
- **Transfer Session**: 表示一次完整的传输会话(文本或文件),包含会话ID、传输类型(文本/文件)、总片段数、已接收片段列表、传输状态(进行中/已完成),接收端用于管理传输进度和恢复

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户使用通用模式生成的二维码,在微信、苹果相机、支付宝等至少3种常见第三方工具中扫描成功率达到100%
- **SC-002**: 用户能在30秒内完成从选择模式到生成二维码的全部操作(包括输入文本或上传文件)
- **SC-003**: 私有模式下,接收端扫描10个二维码片段,在正常扫描速度下(每个二维码停留2秒),整个接收过程不超过25秒完成
- **SC-004**: 文件传输功能支持至少100KB大小的文件,生成的二维码数量不超过50个,接收端能在5分钟内完成扫描和还原
- **SC-005**: 接收端还原的文件与原始文件内容完全一致(通过二进制比对或哈希校验),一致性达到100%
- **SC-006**: 用户在使用文件传输功能时,对于常见文件类型(pdf, jpg, txt),下载后的文件能直接被相应程序打开使用,成功率达到100%
- **SC-007**: 通用模式和私有模式的切换操作,用户能在首次使用时无需查看帮助文档即可理解区别并正确选择,测试用户首次选择正确率达到80%以上
- **SC-008**: 接收端在iOS Safari浏览器上的文件下载功能正常工作,下载成功率达到95%以上(考虑iOS系统限制)

## Assumptions

1. **文件大小策略**: 系统不设硬性文件大小上限,用户可上传任意大小的文件。系统在生成前显示预估的二维码数量和扫描时长,用户根据此信息自主决定是否继续或压缩文件。此设计基于用户自主权原则,同时通过透明的预估信息帮助用户做出明智决策。
2. **通用模式容量**: 假设通用模式下,使用M级纠错的二维码,最大容纳约300字符(中文按3字节计算)。此为行业标准QR码容量估算。
3. **浏览器兼容性**: 假设用户使用的浏览器支持File API(用于文件上传)、Camera API(用于扫描)、Blob/Download API(用于文件下载)。这些API在Chrome 50+, Firefox 52+, Safari 11+, Edge 79+均已支持。
4. **离线运行环境**: 假设用户在完全离线环境下使用(除了初始下载HTML文件),所有QR码库和文件处理逻辑均已内嵌在HTML中。
5. **私有协议格式**: 假设私有协议使用JSON格式封装元数据,格式为: `{type: "text"|"file", index: N, total: M, data: "base64_content", metadata: {...}}`。此格式在发送端和接收端之间约定一致。
6. **文件类型白名单**: 假设系统对文件类型不做严格限制,但对可执行文件(.exe, .sh, .bat, .app)给予警告提示。用户可以选择忽略警告继续传输。
7. **传输会话恢复策略**: 假设接收端使用浏览器LocalStorage临时保存已接收片段(有效期24小时),当用户关闭页面后重新打开时,系统自动恢复未完成的传输会话,显示明显的横幅UI提示当前进度,并提供"重新开始"按钮让用户主动清除会话。此设计兼顾便利性(自动恢复)和用户控制权(可清除重来)。
